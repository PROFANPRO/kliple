<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=yes"/>
  <title>TonConnect — минимальный тест</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#0f172a;color:#fff;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}
    .card{width:360px;padding:18px;border-radius:10px;background:#071029;box-shadow:0 6px 18px rgba(0,0,0,.6)}
    h2{margin:0 0 12px;font-size:18px}
    button{padding:10px 14px;border-radius:8px;border:0;background:#3b82f6;color:#fff;font-weight:600;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    pre{background:#021124;padding:10px;border-radius:6px;max-height:220px;overflow:auto;margin-top:12px;font-size:13px}
    .info{color:#9fb0c8;margin-bottom:10px;font-size:13px}
  </style>
</head>
<body>
  <div class="card">
    <h2>TonConnect — тест</h2>
    <div class="info">Манифест (raw): <br><code id="u" style="word-break:break-all"></code></div>
    <button id="btn" disabled>Инициализация...</button>
    <div class="info" id="status">Статус: ждём</div>
    <pre id="log">Логи:\n</pre>
  </div>

  <!-- TonConnect SDK -->
  <script src="https://unpkg.com/@tonconnect/sdk@2.2.2/dist/tonconnect.umd.min.js"></script>

  <script>
  (async function(){
    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('status');
    const btn = document.getElementById('btn');

    function log(...args){
      console.log(...args);
      logEl.textContent += args.map(a => (typeof a === 'object' ? JSON.stringify(a,null,2) : String(a))).join(' ') + '\\n';
      logEl.scrollTop = logEl.scrollHeight;
    }

    // --- ПРАВИЛЬНЫЙ raw URL (тот, который открыл у тебя JSON)
    const manifestUrl = 'https://raw.githubusercontent.com/PROFANPRO/kliple/main/Tonconnect-manifest.json';
    document.getElementById('u').textContent = manifestUrl;

    statusEl.textContent = 'Проверка манифеста...';
    try {
      const r = await fetch(manifestUrl, { method: 'GET' });
      log('fetch status', r.status, r.statusText);
      if(!r.ok) {
        statusEl.textContent = 'Манифест недоступен: ' + r.status;
        throw new Error('Manifest fetch status ' + r.status);
      }

      // пробуем распарсить JSON
      let manifestJson;
      try {
        manifestJson = await r.json();
        log('Манифест JSON загружен:', manifestJson);
      } catch(parseErr){
        statusEl.textContent = 'Ошибка парсинга JSON';
        log('JSON parse error', parseErr);
        throw parseErr;
      }

      statusEl.textContent = 'Инициализация TonConnect...';

      const tonConnect = new TonConnectSDK.TonConnect({ manifestUrl });

      // попытка восстановить сессию
      try {
        const restored = await tonConnect.restoreConnection();
        if(restored?.account?.address) {
          statusEl.textContent = 'Сессия восстановлена: ' + restored.account.address;
          btn.textContent = '...'+restored.account.address.slice(-4);
        } else {
          statusEl.textContent = 'Нет сохранённой сессии';
          btn.textContent = 'Подключить кошелёк';
        }
      } catch(e){
        log('restoreConnection error', e);
        btn.textContent = 'Подключить кошелёк';
        statusEl.textContent = 'Готово';
      }

      btn.disabled = false;

      btn.addEventListener('click', async () => {
        btn.disabled = true;
        statusEl.textContent = 'Ожидание выбора кошелька...';
        try {
          // используем доступный метод SDK
          let session;
          if(typeof tonConnect.requestConnection === 'function'){
            session = await tonConnect.requestConnection();
          } else if(typeof tonConnect.connect === 'function'){
            session = await tonConnect.connect();
          } else if(typeof tonConnect.connectWallet === 'function'){
            session = await tonConnect.connectWallet();
          } else {
            throw new Error('SDK не содержит методов подключения');
          }

          log('session', session);
          if(session?.account?.address){
            btn.textContent = '...' + session.account.address.slice(-4);
            statusEl.textContent = 'Подключено: ' + session.account.address;
            // попытаемся получить баланс
            try {
              const provider = session.provider;
              const balanceNano = await provider.request({ method: "ton_getBalance", params: [session.account.address] });
              const balance = Number(balanceNano) / 1e9;
              log('Баланс (TON):', balance);
              statusEl.textContent += ' | balance: ' + balance.toFixed(4) + ' TON';
            } catch(e) {
              log('Ошибка получения баланса', e);
            }
          } else {
            statusEl.textContent = 'Подключение завершено (адрес не получен)';
            log('session without address', session);
          }
        } catch(err) {
          log('Ошибка/отмена подключения:', err);
          statusEl.textContent = 'Ошибка или отмена подключения';
        } finally {
          btn.disabled = false;
        }
      });

      statusEl.textContent = 'Готово — нажмите кнопку';
    } catch(err) {
      log('Ошибка при подготовке:', err);
      statusEl.textContent = 'Ошибка: см. логи';
      btn.disabled = true;
    }
  })();
  </script>
</body>
</html>
